"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const async_1 = require("async");
const debug_1 = __importDefault(require("debug"));
const d = debug_1.default("pipeproc:node");
function startWriteBuffer(buffer) {
    d("Starting write buffer");
    let stop = false;
    let stopped = false;
    async_1.forever(function (next) {
        if (stop)
            return next(new Error("stop"));
        if (buffer.length > 0) {
            d("buffer size:", buffer.length);
            const listenerWrapper = buffer.shift();
            if (listenerWrapper) {
                listenerWrapper(function () {
                    setTimeout(next, 10);
                });
            }
            else {
                setTimeout(next, 10);
            }
        }
        else {
            setTimeout(next, 10);
        }
    }, function () {
        stopped = true;
    });
    let timer;
    return function stopWriteBuffer(cb) {
        stop = true;
        if (!stopped) {
            timer = setTimeout(function () {
                d("stopping writeBuffer...");
                stopWriteBuffer(cb);
            }, 10);
        }
        else {
            d("writeBuffer stopped");
            if (timer)
                clearTimeout(timer);
            cb();
        }
    };
}
exports.startWriteBuffer = startWriteBuffer;
